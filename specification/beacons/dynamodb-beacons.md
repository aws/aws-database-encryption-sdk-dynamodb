[//]: # "Copyright Amazon.com Inc. or its affiliates. All Rights Reserved."
[//]: # "SPDX-License-Identifier: CC-BY-SA-4.0"

# DynamoDB Beacons

## Version

1.0.0

### Changelog

## Definitions

 * See the definitions for [beacons](./beacons.md).
 * gazelle prefix : `aws-ddbec-`
 * beacon prefix : `aws-ddbec-sb-`
 * source field : an encrypted DynamoDB attribute with an associated beacon
 * beacon field : an attribute holding the truncated HMAC of a source field,
as defined [here](beacons.md).
The name of the beacon field is the concatenation of
the beacon prefix and the source field name.

### Conventions used in this document

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL"
in this document are to be interpreted as described in [RFC 2119](https://tools.ietf.org/html/rfc2119).

### Overview

A `DynamoDBTableEncryptionConfig` object provides the list of Beacons
for the table associated with an operation,
and other necessary configuration information.

Various Request and Response objects are transformed, based on this configuration.

It should be noted that primary keys cannot be scan beacons,
both because primary keys are not encrypted
and because scan becaons are designed to create false duplicates.

The basic user experience is this 
1. User constructs a client object, registering Gazelle intercepts
2. User calls client methods as normal
3. Gazelle interceptors might call one of the below functions to transform a request, then encrypts the request as necessary.
4. Gazelle interceptors decrypt the response as necessary, then might call one of the functions below to transform the response.
5. User receives the response.

#### Indexing

When a request is made to create a Index for a source field,
instead the index must be created on the scan beacon field.

When the projection contains a source field, the scan beacon field is also included in the projection.

It can be dangerous to specify a projection other than ALL,
because decryption requires the presense of all signed fields
that were present when the record was written.

Users might create tables and/or indexes in the console. In this case,
they must be well educated to perform these same transformations by hand.

#### Writing

Whenever a record is written, if the source field is written then the scan beacon field must also be written.
That is, for every encrypted attribute with a scan beacon, an additional attribute is written.

It is an error to attempt to write a source attribute starting with the gazelle prefix.

#### Reading

To retrieve a record based on the value of an encrypted source field,
search instead for the hash of the value in the scan beacon field.

 * With no beacon, and encrypted attribute cannot be searched.
 * With plain beacons, only exact matches can be supported.
 * compound beacons with a prefix can support ranged queries such as `between` and `begins_with`.
 * compound beacons with a split can support `contains`

It is an error to attempt a query with an unsupported operation.

Because beacons might be truncated, these queries might return false positive results.
After retrieving records in this way,
you examine the decrypted record and compare the source field values to the query values,
and discard any records where they don't match.

### Configuration

In addition to the configuration supplied for each [beacon](beacons.md),
the following OPTIONAL configuration MUST be supported

 * The **Primary Key Parts** : The name of the primary key for the table,
the partition and optional sort key to be used to create this key,
and the [Key Indicator](./beacons.md#key-indicator) used to generate the HMAC.
See [transformPutItemInput](#transformPutItemInput)
 * The **LSI Style** : For each Local Secondary Index, if it should be handled in WIDE or NARROW mode.
(see [transformCreateTableInput](#transformCreateTableInput)

## Operations

#### Note : The object types below are referred to by the Dafny names generated by Polymorph

### transformCreateTableInput

 * This operation MUST take a CreateTableInput object as input.
 * This operation MUST return a CreateTableInput object.
 * This operation MUST return an error if any part of the input
object mentions an attribute name starting with the `gazelle prefix`.
 * If no indexes are being created, and the Primary Key Parts are not configured,
the CreateTableInput object MUST be returned unaltered.
 * If the Primary Key Parts are configured
 * * If no primary key is specified in the input, then a primary key
of the given name and type `Binary` must be added to the input.
 * * If a primary key is specified, and it is not exactly what would have
been added in the previous point, this operation MUST return an error
 * If any Global or Local Secondary Index is being created that references
an encrypted field in its Key Configuration,
 * * if that field does not have a beacon configured, this operation MUST return an error.
 * * otherwise, that field must be changed to be the beacon field, and its type changed to string.
 * If a Global Secondary Index is being created that has an explicit list
of attributes in its projection
 * * if an encrypted field is in its projection, and that field has a beacon configured,
then that beacon must be added to the projection.
 * * if an encrypted field was mentioned in the Key Configuration, then that
encrypted field must be added to the projection.

 * If a Local Secondary Index, explicitly configured as NARROW,
is being created that has an explicit list of attributes in its projection,
and an encrypted field is in its projection, and that field has a beacon configured,
then that field MUST be replaces by its beacon in the projection.
 * If a Local Secondary Index, not explicitly configured as NARROW,
is being created that has an explicit list of attributes in its projection,
 * * if an encrypted field is in its projection, and that field has a beacon configured,
then that beacon MUST also be included in the projection.
 * * if an encrypted field was mentioned in the Key Configuration, then that
encrypted field must be added to the projection.


### transformUpdateTableInput

 * This operation MUST take as input an UpdateTableInput object.
 * This operation MUST return an UpdateTableInput object.
 * This operation MUST return an error if any part of the input
object mentions an attribute name starting with the `gazelle prefix`.

 * If no Global Secondary Index is being created, the UpdateTableInput object MUST be returned unaltered.
 * If a Global Secondary Index being created but it refers to no encrypted fields,
the UpdateTableInput object MUST be returned unaltered.

 * If the Global Secondary Index being created references
an encrypted field in its Key Configuration,
 * * if that field does not have a beacon configured, this operation MUST return an error.
 * * otherwise, that field must be changed to be the beacon field, and its type changed to string.
 * If the Global Secondary Index being created has an explicit list
of attributes in its projection
 * * if an encrypted field is in its projection, and that field has a beacon configured,
then that beacon must be added to the projection.
 * * if an encrypted field was mentioned in the Key Configuration, then that
encrypted field must be added to the projection.


### transformPutItemInput
 * This operation MUST take as input an PutItemInput object.
 * This operation MUST return an PutItemInput object.
 * This operation MUST return an error if any part of the input
object mentions an attribute name starting with the `gazelle prefix`.

 * If the Primary Key Parts are configured
 * * If the primary key is present in the item's attributes, this operation
MUST return an error.
 * * If either the partition or sort key are missing from the input attributes,
this operation MUST return an error; otherwise,
 * * if only a primary key is specified, then an HMAC384 must be generated from it; otherwise,
 * * an HMAC384 must be generated from the concatenation of the partition key,
a literal `_` character, and the sort key.
 * * This HMAC value must be added to the item's attributes.
 * If the input object refers to an encrypted attribute in its Condition Expression,
in any context other than `attribute_exists`, `attribute_not_exists` or `size`,
this operation MUST return an error
 * For each element in the `Item` map that specifies a source field,
 the returned `Item` map MUST also include the scan beacon field.
 * The name of this field MUST be the concatenation of the `scan beacon prefix` and the source field name.
 * The value of this field MUST be the defined [beacon](./beacons.md)


### transformBatchWriteItemInput
 * This operation MUST take as input a BatchWriteItemInput object.
 * This operation MUST return a BatchWriteItemInput object.
 * Each item MUST be handled as outlined above in transformPutItemInput


### transformTransactWriteItemsInput
 * This operation MUST take as input a TransactWriteItemsInput object.
 * This operation MUST return a TransactWriteItemsInput object.
 * Each item MUST be handled as outlined above in transformPutItemInput

#### Note : GetItem, BatchGetItem and TransactGetItems work only on Primary Keys, and therefore are not affected by scan beacons

#### Note PartiQL based methods (executeStatement, batchExecuteStatement, executeTransaction) are beyond the scope of this document.

#### Note : UpdateItem is only allowed to modify unsigned attributes, so we only need to test for the presence of signed attributes, we don't need to modify the request.

### transformUpdateItemInput
 * This operation MUST take as input an UpdateItemInput
 * This operation MUST return the unmodified input object
 * This operation MUST fail if any part of the input
object mentions an attribute name starting with the `gazelle prefix`.
 * This operation MUST fail if the input object attempts to modify a signed attribute.

### Filter Expression Transformation
 * this is a virtual entry point, describing the modification of a
Filter Expression, and possibly the associated Expression Attribute Names
and Expression Attribute Values.
 * This operation MUST fail if an attribute name that starts with the `gazelle prefix` is mentioned.
 * This operation MUST fail if any non-beaconed field is mentioned.
 * If no encrypted field is mentioned, the Filter Expression MUST be returned unmodified.
 * The operations `=`, `IN`, `attribute_exists`, `attribute_not_exists` and `size`;
as well as the boolean `AND`, `OR` and `NOT` are permitted for any type of beacon.
 * The operation `contains` is permitted for split beacons
 * All comparators, and the `BETWEEN` and `begins_with` operations are permitted on prefix beacons.
 * This operation MUST fail if a beacon is used with an operation that is not permitted.
 * Each reference to a field with an unmodified beacon must be replaced by the associated beacon.
For example, `field < value` MUST be replaced by `aws-ddbec-sb-field < beacon_value`
 * Each reference to a field with a modified beacon must be replaced by the union
of the results from the two associated beacons.
For example, `field = value` MUST be replaced by `(aws-ddbec-sb-field = current_beacon_value) OR (aws-ddbec-sb-field = previous_beacon_value)`

### GetTotalQueries
 * GetTotalQueries MUST take as input a QueryInput object
 * GetTotalQueries MUST return an unsigned integer between 1 and 4 inclusive
 * If the `KCE` (Key Condition Expression) mentions no encrypted attribute,
this operation MUST return 1
 * If the `KCE` mentions no attributes with modified beacons,
this operation MUST return 1
 * If the `KCE` mentions only one attributes with a modified beacon, 
this operation MUST return 2
 * otherwise, both the partition key and sort key must have modified beacons.
 * If either modified beacon lacks a version, this operation MUST return 4
 * If both modified beacons have the same version, this operation MUST return 2
 * otherwise, this operation must return 3

### GetQueryNumber
 * GetQueryNumber MUST take as input a QueryInput object
 * GetQueryNumber MUST return an unsigned integer between 1 and 4 inclusive
 * GetQueryNumber MUST return a number no greater than the result of GetTotalQueries
called on the same QueryInput object
 * If the input has no exclusiveStartKey, this operation MUST return 1
 * If the name of the first attribute looks like `#:N:#` where N is a single
decimal digit, then this operation must return N+1
 * If the name of the first attribute starts with `#:N:#` where N is a single
decimal digit, then this operation must return N
 * If exclusiveStartKey exists, but does not begin with `#:N:#`,
 * * if the Key Condition Expression mentions any encrypted fields, this operation MUST fail.
 * * otherwise, this operation MUST return 1

### Transformation  Single Key Comparison
 * this is a virtual entry point, describing the modification of a
Key Comparison Expression, and possibly the associated Expression Attribute Names.
 * This operation also takes as input a flag : CURRENT or PREVIOUS
 * This operation must replace the source field and its value with the
associated beacon field and its beacon value.
For example, `field = value` MUST be replaced by `aws-ddbec-sb-field = beacon_value`

### transformQueryInput
 * This operation MUST take as input a QueryInput object.
 * This operation MUST return a QueryInput object.
 * This operation MUST fail if an attribute name that starts with the `gazelle prefix` is mentioned.
 * This operation MUST fail if any non-beaconed field is mentioned.
 * If no encrypted field is mentioned, this operation MUST return the unmodified input object.
 * If the input object contains a `FilterExpression`, then it must be modified according
to `Filter Expression Transformation` above.
 * If the keyConditionExpression refers to no encrypted attributes, then the result
MUST be returned after only the above operations.

This operation must extract the `Number` from the input 
by calling GetQueryNumber.

 * If the name of the first attribute of the exclusiveStartKey looks like
`#:N:#` where N is a single decimal digit, then the output object
must have no exclusiveStartKey
 * If the name of the first attribute of the exclusiveStartKey starts with
`#:N:#` where N is a single decimal digit, then this prefix must be removed
from the exclusiveStartKey in the output


The Key Condition Expression must be examined

 * The operation `=` is permitted for any type of beacon.
 * All comparators, and the `BETWEEN` and `begins_with` operations are permitted on prefix beacons.
 * This operation MUST fail if the keyConditionExpression compares a source field with an operation that is not permitted.

The Key Condition Expression must be modified

 * For any unmodified beacons mentioned, source field and value MUST
be replaced by the associated beacon and value.

 * If no modified beacons are mentioned,
 * * This operation MUST fail if the `Number` is anything but one
 * * The result MUST be returned after only the above operations.

 * If a single modified beacon is mentioned,
 * * If the `Number` is one, the source field and value MUST
be replaced by the previous version of the associated beacon field and beacon value.
 * * If the `Number` is two, the source field and value MUST
be replaced by the current version of the associated beacon field and beacon value.
 * * If the `Number` is anything but one or two, this operation MUST fail.

 * If two modified beacons are mentioned, and either lacks a version number
 * * If the `Number` is one, the partition and sort fields and their values MUST
be replaced by the previous versions of the associated beacons and beacon values.
 * * If the `Number` is two, the partition field and value MUST
be replaced by the previous version of the associated beacon and beacon value,
and the sort field and value MUST
be replaced by the current version of the associated beacon and beacon value
 * * If the `Number` is three, the partition field and value MUST
be replaced by the current version of the associated beacon and beacon value,
and the sort field and value MUST
be replaced by the previous version of the associated beacon and beacon value
 * * If the `Number` is four, the partition and sort fields and their values MUST
be replaced by the current versions of the associated beacons and beacon values.
 * * If the `Number` is anything but one, two, three or four, this operation MUST fail.


 * If two modified beacons are mentioned, and they have equal version numbers
 * * If the `Number` is one, the partition and sort fields and their values MUST
be replaced by the previous versions of the associated beacons and beacon values.
 * * If the `Number` is two, the partition and sort fields and their values MUST
be replaced by the current versions of the associated beacons and beacon values.
 * * If the `Number` is anything but one or two, this operation MUST fail.


 * If two modified beacons are mentioned, and the partition key version number
is less than the sort key version number
 * * If the `Number` is one, the partition and sort fields and their values MUST
be replaced by the previous versions of the associated beacons and beacon values.
 * * If the `Number` is two, the partition field and value MUST
be replaced by the current version of the associated beacon and beacon value,
and the sort field and value MUST
be replaced by the previous version of the associated beacon and beacon value
 * * If the `Number` is three, the partition and sort fields and their values MUST
be replaced by the current versions of the associated beacons and beacon values.
 * * If the `Number` is anything but one, two or three, this operation MUST fail.


 * If two modified beacons are mentioned, and the partition key version number
is greater than the sort key version number
 * * If the `Number` is one, the partition and sort fields and their values MUST
be replaced by the previous versions of the associated beacons and beacon values.
 * * If the `Number` is two, the partition field and value MUST
be replaced by the previous version of the associated beacon and beacon value,
and the sort field and value MUST
be replaced by the current version of the associated beacon and beacon value
 * * If the `Number` is three, the partition and sort fields and their values MUST
be replaced by the current versions of the associated beacons and beacon values.
 * * If the `Number` is anything but one, two or three, this operation MUST fail.



*Note* : transformQueryOutput needs the original QueryInput object,
because we need to check the result records against the values searched in the QueryInput object, which are not directly available in the QueryOutput object.

### transformQueryOutput
 * This operation MUST take as input a QueryOutput object and a QueryInput object
 * The QueryInput object MUST be assumed to be the original query, not one of the results of transformQueryInput
 * This operation MUST return an QueryOutput object.
 * This operation MUST remove any records for which the original QueryInput does not match, that is,
if the original FilterExpression included `Src EQ "foo"` (where `Src` is a source field)
then this operation must remove any record in which the  `Src` field contains something other than "foo".
 * This operation MUST return all records that match the original QueryInput.

### transformScanInput
 * This operation MUST take as input a ScanInput object.
 * This operation MUST return a ScanInput object.
 * This operation MUST fail if an attribute name that starts with the `gazelle prefix` is mentioned.
 * This operation MUST fail if any non-beaconed field is mentioned.
 * If no encrypted field is mentioned, this operation MUST return the unmodified input object.
 * If the input object contains a `FilterExpression`, then it must be modified according
to `Filter Expression Transformation` above.


### transformScanOutput
 * This operation MUST take as input a ScanOutput object and a ScanInput object.
 * This operation MUST return an ScanOutput object.
 * The ScanInput object MUST be assumed to be the result of transformScanInput call, not the original ScanInput,
and so the original search values will be saved in the ExecutionAttributes of the ScanInput object.
 * This operation MUST remove any records for which the original QueryInput does not match, that is,
if the original FilterExpression included `Src EQ "foo"` (where `Src` is a source field)
then this operation must remove any record in which the  `Src` field contains something other than "foo".
 * This operation MUST return all records that match the original ScanInput.


## Operational Considerations
Fully supporting FilterExpressions, will require a complete parsing of the FilterExpression,
which is sensitive to any updates that the DynamoDB team makes to the expression language.
