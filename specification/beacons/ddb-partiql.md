[//]: # "Copyright Amazon.com Inc. or its affiliates. All Rights Reserved."
[//]: # "SPDX-License-Identifier: CC-BY-SA-4.0"

# DynamoDB and PartiQL

## Version

1.0.0

### Changelog

## Overview

This document assumes familiarity with the [base](./ddb-base.md)
DynamoDB support for beacons, and describes the changes
necesary to add PartiQL support.


Everything above [Conventions used in this document](#conventions-used-in-this-document)
is background information, and is not technically part of the specification,
and therefore any use of the word `must` is strictly colloquial. 

DynamoDB has three operations that deal with PartiQL statements
to update and query a table: ExecuteStatement, BatchExecuteStatement and
ExecuteTransaction.

The base DDBEC implementation simply fails if asked to perform
these operations.

PartiQL support comes in 2 phases.

1. Allow PartiQL statements on tables with no encrypted attributes.
2. Allow PartiQL statements on all tables, forbidding operations
that are forbidden in the [base spec](./ddb-base.md), e.g.
querying on encrypted attributes without beacons or updating 
forbidden fields.



## Conventions used in this document

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL"
in this document are to be interpreted as described in [RFC 2119](https://tools.ietf.org/html/rfc2119).


## Configuration

no changes

## Operations

The object types below are referred to by the Dafny names generated by Polymorph

When the text below says "alter the input" this should be read as
"the output should be equal to the input, but altered in this way".

These operations are defined in terms of functionality
defined in the following section, [Helpers](#beacon-helpers).

These operations MUST have access to a [DynamoDBEncryption](#dynamodbencryption).




### transformExecuteStatementInput
 * transformExecuteStatementInput MUST take as input a ExecuteStatementInput object
 * transformExecuteStatementInput MUST return a ExecuteStatementInput object
 * For phase 1, transformExecuteStatementInput MUST fail if the input object
refers to a table which has any encrypted attributes configured,
otherwise returning the unmodified input object.
 * For phase 2, transformExecuteStatementInput  MUST
rewrite the PartiQL statement as necessary
to search on beacon values rather than encrypted values.


### transformBatchExecuteStatementInput
 * transformBatchExecuteStatementInput MUST take as input a BatchExecuteStatementInput object
 * transformBatchExecuteStatementInput MUST return a BatchExecuteStatementInput object
 * For phase 1, transformBatchExecuteStatementInput MUST fail if the input object
refers to a table which has any encrypted attributes configured,
otherwise returning the unmodified input object.
 * For phase 2, transformBatchExecuteStatementInput  MUST
rewrite the PartiQL statement as necessary
to search on beacon values rather than encrypted values.

### transformExecuteTransactionInput
 * transformExecuteTransactionInput MUST take as input a ExecuteTransactionInput object
 * transformExecuteTransactionInput MUST return a ExecuteTransactionInput object
 * For phase 1, transformExecuteTransactionInput MUST fail if the input object
refers to a table which has any encrypted attributes configured,
otherwise returning the unmodified input object.
 * For phase 2, transformExecuteTransactionInput  MUST
rewrite the PartiQL statement as necessary
to search on beacon values rather than encrypted values.

