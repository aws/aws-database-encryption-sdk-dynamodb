[//]: # "Copyright Amazon.com Inc. or its affiliates. All Rights Reserved."
[//]: # "SPDX-License-Identifier: CC-BY-SA-4.0"

# DynamoDB Primary Key Generation

## Version

1.0.0

### Changelog

## Overview

This document assumes familiarity with the [base](./ddb-base.md)
DynamoDB support for beacons, and describes the changes
necesary to add automatically generated primary keys.

Everything above [Conventions used in this document](#conventions-used-in-this-document)
is background information, and is not technically part of the specification,
and therefore any use of the word `must` is strictly colloquial. 


### Primary Key Generation

A customer might have a table design, where the primary index contains
encrypted attributes.

This is impossible, as primary keys cannot be encrypted,
but we can make it easy for them to work around this.

Gazelle can offer the option to automatically generate a plaintext
primary key from one or more encrypted attributes.

The customer needs to do two things
1. Create a GSI with the same partition and sort keys used in the original design.
1. Configure Primary Key Generation with a new primary key name, and
the partition and sort keys used in the original design.

When the customer writes an item, Gazelle will generate a new primary key
by generating a 48-byte HMAC of the concatenation the original partition and sort keys.

A customer can call GetItem using the original partition and sort keys,
and Gazelle will translate that into a call with the new computed primary key.

A customer can also call GetItem using this generated key,
which they might have as the result of a previous query.

### Writing

Whenever an item is written, the automatically generated
primary key is also written.

### Reading

GetItem and such can either use the attributes used to construct the
primary key, or the primary key itself. In the latter case
the primary key was probably aquired fromm a previous Scan or Query.

## Conventions used in this document

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL"
in this document are to be interpreted as described in [RFC 2119](https://tools.ietf.org/html/rfc2119).


## Configuration

### BeaconVersion

The BeaconVersion object MUST contain

 * primary -- an optional [primary key](#primary-key-generation),

### PrimaryKey

The [PrimaryKey](#primary-key-generation) object MUST contain

 * primary -- the name of the constructed primary key
 * fields -- the names of the attributes to be used to construct `primary`

## Operations

The object types below are referred to by the Dafny names generated by Polymorph

When the text below says "alter the input" this should be read as
"the output should be equal to the input, but altered in this way".

These operations are defined in terms of functionality
defined in the following section, [Helpers](#beacon-helpers).

These operations MUST have access to a [DynamoDBEncryption](#dynamodbencryption).


### transformCreateTableInput

 * if a [generated primary key](#primary-key-generation) is configured, transformCreateTableInput MUST fail
if the input KeySchema is not a single entry, with the
configured name and type `HASH`.
 * if a [generated primary key](#primary-key-generation) is configured, the returned AttributeDefinitions
must include an attribute with the name of the primary, and type "B" binary.


### transformPutItemInput


If a [generated primary key](#primary-key-generation) is configured


, and the primary key name
already exists in `Item`, transformPutItemInput MUST fail.
 * If a [generated primary key](#primary-key-generation) is configured, an additional `Item` MUST be returned
with the configured name, type "B" Binary, and a value as calculated with [calculatePrimaryKeyValue](#calculateprimarykeyvalue). 


### transformGetItemInput


 * If the primary key name already exists in `Key`,
transformPutItemInput MUST return the input unmodified,
 * If the partition and sort keys do not exists in `Key`,
then transformGetItemInput MUST fail.
 * The returned `Key` must be the configured name, type "B" Binary,
and a value as calculated with [calculatePrimaryKeyValue](#calculateprimarykeyvalue). 

## Helpers

### transformPrimaryKeySchema
 * transformPrimaryKeySchema MUST take a KeySchema as input
 * transformPrimaryKeySchema MUST return a KeySchema
 * if no [generated primary key](#primary-key-generation) is configured, transformKeySchema MUST return the unaltered input
 * transformPrimaryKeySchema  MUST fail if the input KeySchema is not empty.
 * transformPrimaryKeySchema MUST return a KeySchema
with the name given in the [generated primary key](#primary-key-generation)  and type `HASH`

### calculatePrimaryKeyValue
 * calculatePrimaryKeyValue MUST take a PutItemInputAttributeMap as input
 * calculatePrimaryKeyValue MUST return `seq<uint8>` of length 48.
 * calculatePrimaryKeyValue MUST fail if no [generated primary key](#primary-key-generation) is configured
 * calculatePrimaryKeyValue MUST fail if any of the configured `fields` are missing from the input attributes.
 * The data key used for the HMACs below MUST be the [beacon key](#beacon-keys) for the primary key name.
 * calculatePrimaryKeyValue MUST return an HMAC384 of the
the [serializations](../dynamodb-encryption-client/ddb-attribute-serialization.md)
of the configured `fields`, joined on the `_` character.

