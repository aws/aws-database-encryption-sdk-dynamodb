[tox]
min_version = 4.0
env_list = 
    py311
    lint
    type
    format-check

[testenv]
description = Run unit tests
deps = 
    pytest
    pytest-cov
    memory-profiler
commands = pytest {posargs:tests}

[testenv:py311]
description = Run tests under Python 3.11
base_python = python3.11
deps = 
    pytest
    pytest-cov
    memory-profiler
commands = pytest {posargs:tests}

[testenv:lint]
description = Run linting checks
deps = 
    flake8
    flake8-docstrings
    flake8-import-order
commands = flake8 src tests

[testenv:type]
description = Run type checking
deps = 
    mypy
    types-PyYAML
    types-psutil
commands = mypy src

[testenv:format]
description = Apply code formatting
deps = black
commands = black src tests

[testenv:format-check]
description = Check code formatting
deps = black
commands = black --check --diff src tests

[testenv:benchmark]
description = Run benchmark suite
deps = 
    aws-dbesdk-dynamodb[legacy-ddbec] @ file:///{toxinidir}/../../../../DynamoDbEncryption/runtimes/python
    boto3>=1.26.0
    PyYAML>=6.0
    pydantic>=2.0.0
    tqdm>=4.66.0
    psutil>=5.9.0
    numpy>=1.24.0
allowlist_externals = python
commands = 
    python -m esdk_benchmark --quick

[testenv:benchmark-full]
description = Run full benchmark suite
deps = 
    aws-dbesdk-dynamodb[legacy-ddbec] @ file:///{toxinidir}/../../../../DynamoDbEncryption/runtimes/python
    boto3>=1.26.0
    PyYAML>=6.0
    pydantic>=2.0.0
    tqdm>=4.66.0
    psutil>=5.9.0
    numpy>=1.24.0
allowlist_externals = python
commands = 
    python -m esdk_benchmark

[testenv:verify]
description = Verify setup and dependencies
deps = 
    PyYAML>=6.0
    pydantic>=2.0.0
    tqdm>=4.66.0
    psutil>=5.9.0
    numpy>=1.24.0
allowlist_externals = python
commands = 
    python verify_setup.py

[testenv:clean]
description = Clean up build artifacts
deps = 
allowlist_externals = 
    rm
    find
commands = 
    rm -rf build/
    rm -rf dist/
    rm -rf *.egg-info/
    find . -type d -name __pycache__ -exec rm -rf {} +
    find . -type f -name "*.pyc" -delete

[flake8]
max-line-length = 88
extend-ignore = E203, W503
max-complexity = 10
per-file-ignores = 
    __init__.py:F401
    tests/*:S101,D103
exclude = 
    .git,
    __pycache__,
    .tox,
    .eggs,
    *.egg,
    build,
    dist,
    .venv
